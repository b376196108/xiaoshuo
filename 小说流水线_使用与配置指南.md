# 小说流水线（xiaoshuo）使用与配置指南（可复用到新题材）

> 目标：用同一套“每日生成 → 章纲/正文/归档 → QA → 合并状态”的流水线，稳定产出连载小说章节；并能通过少量配置切换到全新题材/新书。

---

## 1. 仓库结构（你需要关心的目录）

- `inputs/`
  - **项目规模与全局参数**（章数、默认字数等）
- `canon/`
  - **“真相库/设定库”**：世界观、人物卡、风格指南等（新题材主要改这里）
- `outline/`
  - 全书大纲（可选，但建议有）
- `state/`
  - `current_state.json`：**当前进度与持续性状态**（主线推进、open_loops、时间线锚点）
  - `state_patch.json`：每章生成后写入的**增量补丁（delta only）**，用来合并回 `current_state.json`
- `runs/YYYY-MM-DD/`
  - 每天一次“运行目录”，放当天 brief/context/章纲/QA 报告等
- `manuscript/`
  - 每章正文：`ch001.md`、`ch002.md`……
- `recap/`
  - `chapter_summaries/`：每章摘要
  - `rolling_recap.md`：滚动摘要（连载用的“到目前为止发生了什么”）
- `prompts/roles/`
  - 给 Codex 的角色提示词：`chapter_planner`/`drafter`/`line_editor`/`archivist` 等
- `tools/`
  - 工具脚本：创建每日 run、构建上下文包、QA 连贯性检查、合并 state_patch 等
- `scripts/`
  - Windows/Unix 辅助脚本（如 `run_daily.bat`）

---

## 2. 每日产物与“你要去哪里看什么”

### 2.1 章纲在哪里看
- `runs/YYYY-MM-DD/chapter_plan.md`

章纲里通常应包含：
- `chapter_id: chNNN`
- `target_words: 3200`（或你的目标值）
- `chapter_title: 《……》`（章节标题）
- `timeline_anchor`（时间锚点）
- `Open Loops 推进/advance`（至少 2 条，写明 `id`）
- `Scene List`（分场景目标/冲突/揭示/升级/出钩）

### 2.2 正文在哪里看
- `manuscript/chNNN.md`

**推荐正文文件格式（强烈建议固定下来，便于 QA 与发布）：**
1) 第一行：`# chNNN`  
2) 第二行：`## 《章节标题》`  
3) 从第三行开始：正文（纯小说文本）

### 2.3 摘要在哪里看
- 单章摘要：`recap/chapter_summaries/chNNN.md`
- 滚动摘要：`recap/rolling_recap.md`

### 2.4 当天 QA 报告在哪里看
- `runs/YYYY-MM-DD/qa_report.md`

### 2.5 当天变更日志在哪里看
- `runs/YYYY-MM-DD/changelog.md`

---

## 3. 关键配置：写新题材/新书主要改哪些文件

### 3.1 全局规模与默认字数：`inputs/project_brief.json`
这份文件是“项目规模/默认目标”的主要来源，典型字段：

- `project.*`：题材、调性、主题、世界观锚点等（**新书必改**）
- `scale.total_chapters`：总章数（比如 80）
- `scale.words_per_chapter`：每章默认目标字数（你现在用 3200）
- `constraints.must_have / must_avoid`：必须包含/必须避免（很有用）

> 你如果希望“永远 3200+”，通常要同时做到两件事：  
> 1) `scale.words_per_chapter` 设置为 3200（或更高）；  
> 2) QA 里对“正文最低字符数”的硬规则（通常 >=3000）保持开启。

### 3.2 风格与禁用写法：`canon/style/style_guide.md`
新题材时，你通常要更新：
- POV（第一/第三人称、是否限知）
- 语体（偏现实/偏网文/偏轻松）
- 禁用写法（例如禁止“说明书式科普”、禁止 AI 痕迹等）

### 3.3 世界观与人物：`canon/characters/characters.yaml` 等
你要把“主人公是谁、人物关系、阵营/地点”等写进 canon（建议结构化）。
- 主人公一般会在人物卡中明确（例如 `lin_cen` / 林岑）
- 关键反派/关键资源/关键地点也应在 canon 固化

> 番茄平台填写“主角、主要人物关系”，优先以 `canon/characters/characters.yaml` 为准。

### 3.4 全书大纲：`outline/master_outline.md`
不是强制，但非常推荐：
- 把 80 章拆为 4–8 个大阶段（每阶段目标、关键反转、阶段终钩）
- 每阶段给出 3–5 个必收伏笔与必解伏笔（open_loops 的上层来源）

### 3.5 连载连续性状态：`state/current_state.json`
这里是“当前进度与锁定项”的源头：
- `meta.current_chapter`：当前章节编号（用于推断下一章）
- `meta.words_per_chapter`：默认目标字数（与 project_brief 保持一致）
- `meta.in_story_date`：故事内日期（建议 ISO 或可单调递增的格式）
- `open_loops`：尚未解决的冲突/伏笔列表（建议每条都有 `id`、状态、证据）

---

## 4. 每天怎么跑（手工 Codex 工作流）

你的仓库里可能存在不同版本的“一键准备脚本”。常见两种入口（二选一即可）：

### 4.1 入口 A：准备下一次 run（推荐）
从仓库根目录执行（示例日期自行替换）：
```bash
python tools/prepare_next_run.py --date 2025-12-21
```

它通常会做这些事：
- 创建 `runs/2025-12-21/`
- 生成/更新：
  - `runs/2025-12-21/brief.md`
  - `runs/2025-12-21/context_pack.md`
  - `runs/2025-12-21/manual_codex_instructions.md`
- 自动推断 `chapter_id`（例如从 ch001 → ch002）

> 注意：这一步跑完出现 **warning 或 qa_report=FAIL** 很常见，原因是你还没让 Codex 产出 `chapter_plan`/`manuscript`/`summary`。  
> 只有当 Step1–3 产物齐了，再跑 QA 才有意义。

### 4.2 入口 B：创建当天 run（旧版本常见）
```bash
python tools/create_daily_run.py --date 2025-12-21 --chapter ch002 --target-words 3200
```

---

## 5. Codex 需要做的 3 步（必须按顺序）

以 `runs/YYYY-MM-DD/manual_codex_instructions.md` 为准（你已经把它中文化了）。核心逻辑固定：

1) **Step1：章纲**  
   产出：`runs/YYYY-MM-DD/chapter_plan.md`

2) **Step2：正文 + 行文润色**  
   产出：`manuscript/chNNN.md`  
   建议强制格式：  
   - 第一行 `# chNNN`  
   - 第二行 `## 《章节标题》`（来自 chapter_plan 的 `chapter_title`）  
   - 正文长度（不含标题与空白）**>=3000 字符**（建议 3200–3800）

3) **Step3：摘要 + 滚动摘要 + 状态补丁 + changelog**  
   产出：
   - `recap/chapter_summaries/chNNN.md`
   - `recap/rolling_recap.md`
   - `state/state_patch.json`（delta only，必须含 `meta.current_chapter: "chNNN"`）
   - `runs/YYYY-MM-DD/changelog.md`

---

## 6. QA 与合并（只有 PASS 才能合并）

### 6.1 跑 QA
```bash
python tools/continuity_checks.py --date 2025-12-21 --chapter ch002
```

### 6.2 PASS 才合并 state_patch
```bash
python tools/merge_state_patch.py --date 2025-12-21
```

合并成功后：
- `state/current_state.json` 会被推进到最新章节
- `state/backups/` 里可能会生成备份（看你版本是否启用）

---

## 7. 你关心的“字数、标题、open_loops”三大硬规则怎么改

> 下面说的是“规则应该放在哪里”。你仓库的具体脚本名可能略有差异，但逻辑一致。

### 7.1 每章默认目标字数（3200）
- 首选：改 `inputs/project_brief.json`
  - `scale.words_per_chapter = 3200`
- 次选：改 `state/current_state.json`
  - `meta.words_per_chapter = 3200`

### 7.2 正文最低字数硬门槛（>=3000 字符）
通常在 `tools/continuity_checks.py` 里有常量/规则（例如 `MIN_BODY_CHARS = 3000`）。
- 你想更高：改成 3200/3500
- 你想更宽松：改成 2500（不建议）

> QA 的“字数”一般是按**字符数**统计，且会把标题/空白剔除，这样能避免用标题或空行凑数。

### 7.3 自动带出本章标题（强烈建议）
让 QA 能检查并让你发平台更方便，建议固定：
- `chapter_plan.md` 必须有：`chapter_title: 《……》`
- `manuscript/chNNN.md` 第二行必须是：`## 《……》`

如果你希望“标题自动生成”，有三种策略：

- 策略 A（最稳）：**章纲阶段生成标题**  
  在 `prompts/roles/chapter_planner.md` 里把“必须产出 chapter_title”写成硬约束。  
  然后在 Step2 要求 drafter 直接抄用它。

- 策略 B：工具脚本生成标题骨架  
  使用/扩展 `tools/chapter_title.py`（如果你版本里有）：
  - 输入：本章目标、open_loops、关键词
  - 输出：若干候选标题（给 chapter_planner 选择）

- 策略 C：先空标题，后由 line_editor 补（不推荐）  
  这会导致 QA 经常因为 title_missing 提前 FAIL。

### 7.4 open_loops 至少推进 2 条
通常 QA 会要求：chapter_plan 中标注推进的 open_loops **>=2**，并且：
- 摘要里能提取到证据（evidence）
- state_patch 里对应 loop 状态有变化

---

## 8. 想用同一套代码写“另一部新书”，怎么做（保留工具链，重置内容）

你说的“保留设定重写（方案A）/清空重来（方案B）”，本质是下面两类操作：

### 8.1 新书（换题材）推荐做法：复制一份仓库
最干净，零串线风险：
- 把整个仓库复制成一个新目录（例如 `xiaoshuo_new_book/`）
- 在新目录里改 `inputs/` + `canon/` + `outline/` + `state/current_state.json`
- 旧书数据不动，新书完全隔离

### 8.2 在同一仓库里“清空重来”（你刚才做的）
一般需要清空这些产物：
- `manuscript/*`
- `recap/chapter_summaries/*`
- `runs/YYYY-MM-DD/`（保留你想留的报告也可以）
- `state/state_patch.json`
- `state/backups/*`（可选）

然后重置这些“源文件”：
- `recap/rolling_recap.md`：写成空模板（UTF-8，无 BOM）
- `state/current_state.json`：重置 meta（例如 `current_chapter: "ch000"`）、清空 open_loops 或写入新书 open_loops
- 更新 `inputs/project_brief.json` + `canon/*` + `outline/*`

---

## 9. 编码与乱码（非常重要，避免 “????” 和 JSON BOM 报错）

### 9.1 结论
- **所有 .md/.json 必须是 UTF-8**
- JSON **强烈建议 UTF-8 无 BOM**
- 出现大量 `????`：基本就是编码错了或写了占位符，必须重做

### 9.2 你遇到过的 JSONDecodeError: Unexpected UTF-8 BOM
快速修复（推荐用 Python 一行修复为无 BOM）：
```bash
python -c "from pathlib import Path; p=Path('state/current_state.json'); s=p.read_text(encoding='utf-8-sig'); p.write_text(s, encoding='utf-8'); print('fixed: removed BOM')"
```

### 9.3 VSCode 推荐设置
- 右下角显示 `UTF-8`
- 保存时不要自动转成其他编码
- JSON 尽量让工具脚本写入（少用 PowerShell 直接写 JSON）

---

## 10. 常见 QA FAIL 怎么改（不影响下一章，反而是“保证下一章不崩”的关键）

你最常见会遇到这些：

- `missing chapter_plan / manuscript / summary`  
  说明你只跑了“准备 run”，但还没让 Codex 执行 Step1–3。  
  **处理：按 manual_codex_instructions 让 Codex 产出对应文件。**

- `chapter_id_mismatch`  
  `state.meta.current_chapter` / `state_patch.meta.current_chapter` / `manuscript` 文件名不一致。  
  **处理：统一成同一个 chNNN。**

- `open_loops_advance_min_2`  
  chapter_plan 里没明确写推进的 loop id。  
  **处理：在 chapter_plan 的 advance 列表写至少两条 id，并在 summary/state_patch 对应体现证据。**

- `title_missing_or_invalid`  
  正文第二行缺 `## 《标题》` 或与 chapter_plan 的 `chapter_title` 不一致。  
  **处理：补齐第二行标题，并确保与 chapter_plan 一致。**

- `BodyTooShort`  
  **处理：只扩写正文（行动/对话/阻碍升级），不要灌水。扩完再跑 Step3 再 QA。**

这些修复不会“影响下一章生成”，相反：  
- state/current_state.json 被修复后，下一章推断 chapter_id 才会正确；  
- open_loops/标题规则被补齐后，下一章不会继续报同类 FAIL。

---

## 11. 番茄小说平台需要的几个字段：建议你在仓库里固定位置

你问“书名、简介、每章标题、主人公在哪”。目前这套仓库对“书名/作品简介”未必有强制字段，建议你建立统一来源，避免每次到处找：

- **书名**：建议新增文件 `canon/book.md`（或在 `canon/premise.md` 顶部加“书名：”）
- **作品简介**：建议放在 `canon/book.md`，并由工具把它拼到 `context_pack.md` 里
- **每章标题**：`runs/YYYY-MM-DD/chapter_plan.md` 的 `chapter_title`，以及 `manuscript/chNNN.md` 第二行
- **主人公**：`canon/characters/characters.yaml` + `state/current_state.json` 的 POV 锁定信息

---

## 12. 你要测试“生成 ch002”，应该预期什么现象？

1) 先跑准备命令（例如）：
```bash
python tools/prepare_next_run.py --date 2025-12-21
```

2) 此时出现：
- `AutoTitle skipped: missing .../chapter_plan.md`（warning）
- `qa_report.md (result=FAIL)`（常见）

这是**正常的**：因为章纲/正文/摘要还没生成。

3) 你需要打开当日：
- `runs/2025-12-21/manual_codex_instructions.md`

按 Step1–3 喂给 VSCode Codex 生成文件。

4) 再跑 QA：
```bash
python tools/continuity_checks.py --date 2025-12-21 --chapter ch002
```

5) PASS 才 merge：
```bash
python tools/merge_state_patch.py --date 2025-12-21
```

---

## 13. 快速自检清单（每天 30 秒）

- [ ] `chapter_plan.md` 有 `chapter_title`，且 **open_loops advance >=2**（写明 id）
- [ ] `manuscript/chNNN.md` 第一行 `# chNNN`，第二行 `## 《标题》`
- [ ] 正文字符数 >=3000（建议 3200+）
- [ ] `state_patch.json` 是 delta only，且 `meta.current_chapter == chNNN`
- [ ] QA PASS 后再 merge

---
