# 新开小说说明书

本说明用于在本仓库内“重置并启动一部新小说”的基础配置。适用场景：新开一部小说、已有小说需要重置重写、同一系统内并行两本小说。

## 一、开始前必读
- 所有文档统一使用 UTF-8（无 BOM），换行使用 LF。
- 章节编号统一为字符串格式 `chNNN`（如 `ch001`）。
- 唯一输入真相源为 `inputs/project_brief.json`（严格 JSON）。
- `inputs/project_brief.yaml` 仅作可读镜像，不参与程序逻辑。

## 二、必须修改的基础文档（按顺序）

### 1) 项目输入配置
1. `inputs/project_brief.json`
   - 更新题材、基调、受众尺度、核心钩子、主题、世界设定锚点。
   - 更新 `scale.total_chapters` 与 `scale.words_per_chapter`。
   - 保持严格 JSON，不写注释、不写占位符。

### 2) 核心设定与风格
2. `canon/premise.md`
   - 一句话世界观 + 核心冲突 + 主角动机。
   - 明确“不可突破规则”（资源、技术、社会秩序）。
3. `canon/style/style_guide.md`
   - 固定 POV、人称、时态、章节结构。
   - 强调标题格式：正文第一行 `# chNNN`，第二行 `## 《标题》`。
4. `canon/rules/world_rules.md`
   - 写清“硬规则”：资源稀缺、交易成本、政务规则、工具材料限制。

### 3) 角色、地点、势力
5. `canon/characters/characters.yaml`
   - 至少 10 个角色，字段包含：`id/name/aliases/goal/flaw/secret/arc/relationships/status/location/knowledge_flags`。
6. `canon/locations/locations.yaml`
   - 至少 10 个地点，包含 `atmosphere` 与 `rules`。
7. `canon/factions/factions.yaml`
   - 至少 3 个势力，包含 `motive/resources/public_face/secret`。

### 4) 故事结构与状态
8. `outline/master_outline.md`
   - 明确总章数与三幕结构。
   - 写出每 10 章里程碑与前 10 章拍表。
9. `state/current_state.json`
   - `meta.current_chapter` 设置为 `ch001`，并与 `project_brief.json` 的总章数/字数一致。
   - 初始化角色状态（位置/目标/状态/知识标记）。
   - `open_loops` 至少 2 条，`id` 必须 ASCII，含 `planned_payoff_window`。

## 三、可选但建议检查的提示词与规范
如需调整写作风格或强化规则，可检查以下文件（只做与新题材一致的改动）：
- `prompts/roles/chapter_planner.md`
- `prompts/roles/drafter.md`
- `prompts/roles/line_editor.md`
- `prompts/roles/archivist.md`
- `prompts/roles/punch_up_editor.md`

## 四、启动新书的推荐流程
1. 完成以上基础文档修改后，运行每日准备：
   - `python tools/prepare_next_run.py --date YYYY-MM-DD`
2. 按 `runs/YYYY-MM-DD/manual_codex_instructions.md` 的 Step1–Step3 生成章纲、正文、归档。
3. 运行 QA：
   - `python tools/continuity_checks.py --date YYYY-MM-DD --chapter ch001`
4. QA 通过后合并状态：
   - `python tools/merge_state_patch.py --date YYYY-MM-DD`

## 五、快速检查清单
- `inputs/project_brief.json` 可被 `json` 解析。
- `state/current_state.json` 与 `outline/master_outline.md` 的总章数一致。
- `chapter_title` 与正文标题格式一致。
- `open_loops` 在章纲、摘要、state_patch 中可一一对齐。

## 六、已写小说需要重置重写（清空旧内容）
建议先完整备份旧项目，再重置基础文档，避免历史内容污染新书。

### 1) 先做备份（推荐）
将以下目录或文件复制到仓库外（或自建归档目录）：
- `manuscript/`
- `recap/`
- `runs/`
- `outline/master_outline.md`
- `state/current_state.json`
- `canon/`（若要保留旧设定对照）

### 2) 清理旧产物（不要混写）
在确认备份无误后，清理旧书产物：
- 清空 `manuscript/ch*.md`
- 清空 `recap/chapter_summaries/*.md` 与 `recap/rolling_recap.md`
- 清空 `runs/` 下旧日期目录
- 清空 `state/state_patch.json`（或保留空对象）

### 3) 重新初始化新书
按“第二部分”重新填写 `inputs/project_brief.json`、`canon/`、`outline/`、`state/current_state.json`，把 `meta.current_chapter` 设为 `ch001`。

## 七、已有小说项目需要重置（更换题材或彻底重写）
操作与“六”一致，关键原则是：
- 先备份，再清理，再重建基础文档。
- 旧书的 `manuscript/`、`recap/`、`runs/`、`state/` 不要与新书混用。

## 八、同一系统写两本不同小说（推荐做法）
由于本系统使用单一 `manuscript/` 与 `state/`，同一工作区不适合并行两本书。

### 推荐方案：分开仓库目录
为每本书复制一个独立仓库目录：
- 例如 `xiaoshuo_bookA/` 与 `xiaoshuo_bookB/`
- 各自维护独立的 `inputs/`、`canon/`、`outline/`、`state/`、`manuscript/`、`recap/`、`runs/`

### 进阶方案：使用 git worktree
如果必须共用一个 Git 仓库，可用不同分支 + 不同工作区：
- 每本书使用独立分支与独立工作树
- 仍然保持各自独立的 `state/` 与 `manuscript/`
- 禁止在同一工作区内混写两本书

## 九、常见错误提醒
- 不要在未清理旧书时直接改新书设定，容易引发串台。
- 不要让 `chapter_title` 与正文标题格式不一致，会触发 QA 失败。
- 不要在 `inputs/project_brief.json` 里写注释或占位符。
